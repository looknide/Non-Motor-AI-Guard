  <!-- 编辑资料模态窗口 -->
    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <span class="modal-close" id="edit-profile-close">&times;</span>
            <h2 class="modal-title">编辑个人资料</h2>
            <form class="modal-form" id="edit-profile-form">
                <div class="form-group">
                    <label for="edit-name">姓名</label>
                    <input type="text" id="edit-name" class="form-input" value="李明">
                </div>
                <div class="form-group">
                    <label for="edit-position">职位</label>
                    <input type="text" id="edit-position" class="form-input" value="高级交通监察员">
                </div>
                <div class="form-group">
                    <label for="edit-phone">电话</label>
                    <input type="text" id="edit-phone" class="form-input" value="13812346542">
                </div>
                <div class="form-group">
                    <label for="edit-email">邮箱</label>
                    <input type="email" id="edit-email" class="form-input" value="li.ming@traffic.gov.cn">
                </div>
                <div class="form-group">
                    <label for="edit-department">所属部门</label>
                    <input type="text" id="edit-department" class="form-input" value="城东区交通管理中心">
                </div>
                <button type="submit" class="form-submit">保存修改</button>
            </form>
        </div>
    </div>
    
    <!-- 报告问题模态窗口 -->
    <div class="modal" id="report-issue-modal">
        <div class="modal-content">
            <span class="modal-close" id="report-issue-close">&times;</span>
            <h2 class="modal-title">报告系统问题</h2>
            <form class="modal-form" id="report-issue-form">
                <div class="form-group">
                    <label for="issue-type">问题类型</label>
                    <select id="issue-type" class="form-input">
                        <option value="bug">系统错误</option>
                        <option value="suggestion">功能建议</option>
                        <option value="data">数据异常</option>
                        <option value="permission">权限问题</option>
                        <option value="other">其他问题</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="issue-title">问题标题</label>
                    <input type="text" id="issue-title" class="form-input" placeholder="请简要描述问题">
                </div>
                <div class="form-group">
                    <label for="issue-description">详细描述</label>
                    <textarea id="issue-description" class="form-textarea" placeholder="请详细描述您遇到的问题..."></textarea>
                </div>
                <div class="form-group">
                    <label for="issue-attachment">附件（可选）</label>
                    <input type="file" id="issue-attachment" class="form-input">
                </div>
                <button type="submit" class="form-submit">提交问题</button>
            </form>
        </div>
    </div><!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NON-MOTOR AI GUARD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #0a0a1a;
            color: #ffffff;
            min-height: 100vh;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 240px;
            background: linear-gradient(180deg, #151540 0%, #0d0d2d 100%);
            padding: 20px 0;
            border-right: 1px solid #2a2a5a;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .sidebar-title {
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 2px;
            color: #ffffff;
            text-shadow: 0 0 10px rgba(150, 100, 255, 0.7);
            text-align: center;
            margin-bottom: 30px;
            padding: 0 10px;
        }
        
        .sidebar-nav {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: 30px;
        }
        
        .nav-button {
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 12px 0;
            text-align: center;
            background: linear-gradient(90deg, #1a1a4a 0%, #232368 100%);
            color: #ffffff;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            background: linear-gradient(90deg, #2a2a7a 0%, #3333a8 100%);
            box-shadow: 0 0 15px rgba(100, 100, 255, 0.5);
            transform: translateX(5px);
        }
        
        .hamburger {
            display: none;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .main-header {
            text-align: center;
            padding-bottom: 20px;
        }
        
        .main-title {
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 3px;
            color: #ffffff;
            text-shadow: 0 0 10px rgba(150, 100, 255, 0.7);
        }
        
        .dashboard {
            display: flex;
            flex: 1;
            height: calc(100vh - 100px);
        }
        
        .content-container {
            flex: 3;
            display: flex;
            flex-direction: column;
            margin-right: 20px;
        }
        
        /* Chat Interface Styles */
        .chat-window {
            background-color: rgba(30, 30, 60, 0.4);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            position: relative;
            height: calc(100vh - 130px);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 15px;
            /* 自定义滚动条样式 */
            scrollbar-width: thin;
            scrollbar-color: rgba(170, 93, 249, 0.5) rgba(40, 40, 100, 0.2);
        }
        
        /* Webkit浏览器的滚动条样式 */
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: rgba(40, 40, 100, 0.2);
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(170, 93, 249, 0.5);
            border-radius: 10px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(170, 93, 249, 0.8);
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #2a2a7a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .message.user .message-avatar {
            order: 2;
            margin-left: 10px;
            margin-right: 0;
            background-color: #aa5df9;
        }
        
        .message-content {
            background: linear-gradient(135deg, rgba(40, 40, 100, 0.6) 0%, rgba(60, 60, 150, 0.4) 100%);
            padding: 12px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-break: break-word;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, rgba(170, 93, 249, 0.6) 0%, rgba(130, 70, 200, 0.4) 100%);
            text-align: right;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
            position: relative;
        }
        
        .chat-input {
            flex: 1;
            background-color: rgba(50, 50, 100, 0.4);
            border: 1px solid rgba(100, 100, 255, 0.3);
            border-radius: 25px;
            padding: 12px 50px 12px 20px;
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .chat-input:focus {
            border-color: rgba(170, 93, 249, 0.6);
            box-shadow: 0 0 10px rgba(170, 93, 249, 0.4);
        }
        
        .image-upload {
            position: absolute;
            right: 145px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #aa5df9;
            cursor: pointer;
            font-size: 24px;
        }
        
        .send-button {
            background: linear-gradient(90deg, #aa5df9 0%, #8246c8 100%);
            border: none;
            border-radius: 25px;
            padding: 0 25px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .send-button:hover {
            box-shadow: 0 0 15px rgba(170, 93, 249, 0.5);
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 150px;
            margin-top: 10px;
            border-radius: 10px;
            display: none;
        }
        
        #fileInput {
            display: none;
        }
        
        /* 用户资料区域样式 */
        .user-profile {
            background-color: rgba(30, 30, 60, 0.4);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 350px;
        }
        
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 15px;
            border: 3px solid rgba(170, 93, 249, 0.7);
            position: relative;
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-edit {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(40, 40, 100, 0.8);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .avatar-edit:hover {
            background: rgba(170, 93, 249, 0.8);
        }
        
        .avatar-edit label {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        #avatar-upload {
            display: none;
        }
        
        .profile-name {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .profile-name h3 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #fff;
        }
        
        .badge {
            background: linear-gradient(90deg, #2a2a7a 0%, #3333a8 100%);
            color: #fff;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .profile-info {
            margin-bottom: 30px;
        }
        
        .info-group {
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(100, 100, 255, 0.2);
            padding-bottom: 10px;
        }
        
        .info-group label {
            display: block;
            color: #8889ce;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .info-group div {
            color: #fff;
            font-size: 16px;
        }
        
        .profile-actions {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .profile-btn {
            background: linear-gradient(90deg, #2a2a7a 0%, #3333a8 100%);
            border: none;
            border-radius: 5px;
            padding: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .profile-btn:hover {
            background: linear-gradient(90deg, #3333a8 0%, #4444c2 100%);
            box-shadow: 0 0 15px rgba(100, 100, 255, 0.5);
        }
        
        .report-btn {
            background: linear-gradient(90deg, #5a1e5a 0%, #8a2e8a 100%);
        }
        
        .report-btn:hover {
            background: linear-gradient(90deg, #8a2e8a 0%, #a53ea5 100%);
            box-shadow: 0 0 15px rgba(170, 93, 249, 0.5);
        }
        
        /* 模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, rgba(30, 30, 80, 0.95) 0%, rgba(20, 20, 60, 0.95) 100%);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 0 30px rgba(100, 100, 255, 0.5);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            color: #aa5df9;
        }
        
        .modal-title {
            margin-bottom: 20px;
            color: #fff;
            font-size: 20px;
            text-align: center;
        }
        
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 10px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #bcbcff;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 15px;
            background-color: rgba(40, 40, 100, 0.3);
            border: 1px solid rgba(100, 100, 255, 0.3);
            border-radius: 5px;
            color: #fff;
            font-size: 16px;
        }
        
        .form-textarea {
            width: 100%;
            padding: 10px 15px;
            background-color: rgba(40, 40, 100, 0.3);
            border: 1px solid rgba(100, 100, 255, 0.3);
            border-radius: 5px;
            color: #fff;
            font-size: 16px;
            min-height: 120px;
            resize: vertical;
        }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: rgba(170, 93, 249, 0.6);
            box-shadow: 0 0 10px rgba(170, 93, 249, 0.4);
        }
        
        .form-submit {
            margin-top: 10px;
            background: linear-gradient(90deg, #aa5df9 0%, #8246c8 100%);
            border: none;
            border-radius: 5px;
            padding: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .form-submit:hover {
            background: linear-gradient(90deg, #bb6eff 0%, #9257d9 100%);
            box-shadow: 0 0 15px rgba(170, 93, 249, 0.5);
        }
        
        /* 响应式调整 */
        @media (max-width: 992px) {
            .user-profile {
                max-width: none;
            }
            
            .profile-header {
                flex-direction: row;
                align-items: center;
                justify-content: flex-start;
                gap: 20px;
            }
            
            .profile-avatar {
                width: 80px;
                height: 80px;
                margin-bottom: 0;
            }
        }
        
        @media (max-width: 992px) {
            .dashboard {
                flex-direction: column;
            }
            
            .content-container {
                margin-right: 0;
                margin-bottom: 20px;
            }
            
            .data-summary {
                min-height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            .hamburger {
                display: block;
            }
            
            .sidebar {
                position: fixed;
                left: -240px;
                height: 100vh;
                z-index: 999;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                width: 100%;
                margin-left: 0;
            }
            
            .chat-window {
                height: calc(100vh - 150px);
            }
        }
        
        @media (max-width: 480px) {
            .main-title {
                font-size: 22px;
            }
            
            .chat-window {
                height: calc(100vh - 120px);
            }
            
            .message-content {
                max-width: 85%;
            }
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #aa5df9;
            font-size: 18px;
        }
        
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6666;
            font-size: 16px;
            text-align: center;
        }
        
        /* Typing indicator */
        .typing-indicator {
            display: none;
            padding: 10px;
            background: rgba(40, 40, 100, 0.4);
            border-radius: 20px;
            width: 70px;
            margin-left: 50px;
        }
        
        .typing-indicator span {
            height: 10px;
            width: 10px;
            float: left;
            margin: 0 1px;
            background-color: #aa5df9;
            display: block;
            border-radius: 50%;
            opacity: 0.4;
            animation: typing 1s infinite;
        }
        
        .typing-indicator span:nth-of-type(1) { animation-delay: 0s; }
        .typing-indicator span:nth-of-type(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-of-type(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="hamburger" id="menu-toggle">☰</button>
        
        <div class="sidebar" id="sidebar">
            <div class="sidebar-title">NON-MOTOR AI GUARD</div>
            <div class="sidebar-nav">
                <button class="nav-button" id="home-btn">登录页</button>
                <button class="nav-button" id="dashboard-btn">主页</button>
                <button class="nav-button" id="details-btn">详情页</button>
                <button class="nav-button active" id="vlm-btn">智能交互页</button>
                <button class="nav-button" id="review-btn">申请复核</button>
                <button class="nav-button" id="contact-btn">联系开发商</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="main-header">
                <h1 class="main-title">非机动车智能监控系统</h1>
            </div>
            
            <div class="dashboard">
                <div class="content-container">
                    <div class="chat-window">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message">
                                <div class="message-avatar">助手</div>
                                <div class="message-content">
                                    你好！我是非机动车智能监控系统的AI助手。有什么我可以帮助你的吗？
                                </div>
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typingIndicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        
                        <img id="imagePreview" class="image-preview" src="" alt="图片预览">
                        
                        <div class="chat-input-container">
                            <input type="text" class="chat-input" id="chatInput" placeholder="请输入您的问题..." autocomplete="off">
                            <label for="fileInput" class="image-upload">📷</label>
                            <input type="file" id="fileInput" accept="image/*">
                            <button class="send-button" id="sendButton">发送</button>
                        </div>
                    </div>
                </div>
                
                <div class="data-summary user-profile">
                    <div class="profile-header">
                        <div class="profile-avatar">
                            <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" alt="用户头像" id="profile-image">
                            <div class="avatar-edit">
                                <label for="avatar-upload" title="更换头像">📷</label>
                                <input type="file" id="avatar-upload" accept="image/*">
                            </div>
                        </div>
                        <div class="profile-name">
                            <h3 id="user-name">李明</h3>
                            <div class="badge">已认证</div>
                        </div>
                    </div>
                    
                    <div class="profile-info">
                        <div class="info-group">
                            <label>职位</label>
                            <div id="user-position">交通警卫处 · 高级交通监察员</div>
                        </div>
                        <div class="info-group">
                            <label>警员编号</label>
                            <div id="user-id">TPC-20210734</div>
                        </div>
                        <div class="info-group">
                            <label>电话</label>
                            <div id="user-phone">138****6542</div>
                        </div>
                        <div class="info-group">
                            <label>邮箱</label>
                            <div id="user-email">li.ming@traffic.gov.cn</div>
                        </div>
                        <div class="info-group">
                            <label>所属部门</label>
                            <div id="user-department">城东区交通管理中心</div>
                        </div>
                        <div class="info-group">
                            <label>入职时间</label>
                            <div id="user-join-date">2021-07-15</div>
                        </div>
                    </div>
                    
                    <div class="profile-actions">
                        <button id="edit-profile-btn" class="profile-btn">编辑资料</button>
                        <button id="report-issue-btn" class="profile-btn report-btn">报告系统问题</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <script type="module">
        // Google AI API Key
        const API_KEY = 'AIzaSyDsGrmSxmKo3lTW4Ukk4TtRMRbdt_noFZY';
        
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // 初始化 Google Generative AI
        const genAI = new GoogleGenerativeAI(API_KEY);
        
        // 获取Gemini模型
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
        
        // 创建弹窗元素
        function createModal(content) {
            // 删除已有的弹窗（如果存在）
            const existingModal = document.querySelector('.modal-container');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建新弹窗
            const modalContainer = document.createElement('div');
            modalContainer.className = 'modal-container';
            modalContainer.style.position = 'fixed';
            modalContainer.style.top = '0';
            modalContainer.style.left = '0';
            modalContainer.style.width = '100%';
            modalContainer.style.height = '100%';
            modalContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            modalContainer.style.display = 'flex';
            modalContainer.style.justifyContent = 'center';
            modalContainer.style.alignItems = 'center';
            modalContainer.style.zIndex = '9999';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.backgroundColor = 'rgba(30, 30, 80, 0.95)';
            modalContent.style.padding = '30px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.boxShadow = '0 0 20px rgba(150, 100, 255, 0.5)';
            modalContent.style.textAlign = 'center';
            modalContent.style.maxWidth = '400px';
            modalContent.style.width = '90%';
            modalContent.style.color = 'white';
            modalContent.style.border = '1px solid rgba(150, 100, 255, 0.3)';
            
            modalContent.innerHTML = content;
            
            const closeButton = document.createElement('button');
            closeButton.textContent = '关闭';
            closeButton.style.marginTop = '20px';
            closeButton.style.padding = '8px 20px';
            closeButton.style.backgroundColor = 'rgba(120, 80, 220, 0.8)';
            closeButton.style.border = 'none';
            closeButton.style.borderRadius = '5px';
            closeButton.style.color = 'white';
            closeButton.style.cursor = 'pointer';
            
            closeButton.addEventListener('click', () => {
                modalContainer.remove();
            });
            
            modalContent.appendChild(closeButton);
            modalContainer.appendChild(modalContent);
            document.body.appendChild(modalContainer);
        }

        // Chat interface functions
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const typingIndicator = document.getElementById('typingIndicator');
        
        let selectedFile = null;
        
        // 将File对象转换为GenerativePart
        async function fileToGenerativePart(file) {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { 
                    data: await base64EncodedDataPromise, 
                    mimeType: file.type 
                },
            };
        }
        
        // Add user message to chat
        function addUserMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            
            messageDiv.innerHTML = `
                <div class="message-content">${text}</div>
                <div class="message-avatar">用户</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Add bot message to chat
        function addBotMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">助手</div>
                <div class="message-content">${text}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Handle image upload
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedFile = file;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });
        
        // 创建聊天对象
        let chat = model.startChat({
            history: [
                {
                    role: "user",
                    parts: [{ text: "你好，请以非机动车智能监控系统的助手的身份与我交流。" }],
                },
                {
                    role: "model",
                    parts: [{ text: "你好！我是非机动车智能监控系统的助手。有什么我可以帮助你的吗？" }],
                },
            ],
        });
        
        // Handle sending messages
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message && !selectedFile) return;
            
            // Clear input
            chatInput.value = '';
            
            // Add user message to chat
            if (message) {
                addUserMessage(message);
            }
            
            // 如果有图片，处理图片
            let parts = [{ text: message }];
            
            if (selectedFile) {
                try {
                    const imagePart = await fileToGenerativePart(selectedFile);
                    parts.push(imagePart);
                    
                    // 在聊天中显示图片
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message user';
                    
                    const img = document.createElement('img');
                    img.src = imagePreview.src;
                    img.style.maxWidth = '200px';
                    img.style.borderRadius = '10px';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'message-content';
                    contentDiv.appendChild(img);
                    
                    messageDiv.appendChild(contentDiv);
                    messageDiv.innerHTML += `<div class="message-avatar">用户</div>`;
                    
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } catch (error) {
                    console.error('处理图片失败:', error);
                }
                
                // Reset image preview
                imagePreview.style.display = 'none';
                imagePreview.src = '';
                selectedFile = null;
            }
            
            // Show typing indicator
            typingIndicator.style.display = 'block';
            
            try {
                // 使用聊天API
                const result = await chat.sendMessage(parts);
                const response = await result.response;
                const responseText = response.text();
                
                // Hide typing indicator and add bot response
                typingIndicator.style.display = 'none';
                addBotMessage(responseText);
                
            } catch (error) {
                console.error('API调用失败:', error);
                typingIndicator.style.display = 'none';
                
                // 使用备选响应
                const fallbackResponses = [
                    "作为非机动车智能监控系统的助手，我可以帮您解答关于非机动车管理和违规行为的问题。",
                    "我们的系统能够识别多种违规行为，包括闯红灯、逆行和占用机动车道等。您有什么具体想了解的吗？",
                    "非机动车管理是城市交通秩序的重要组成部分。我可以为您提供相关法规和处罚信息。"
                ];
                const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
                addBotMessage(randomResponse);
            }
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
        
        // 用户资料相关功能
        function setupProfileFunctions() {
            // 头像上传功能
            const avatarUpload = document.getElementById('avatar-upload');
            const profileImage = document.getElementById('profile-image');
            
            avatarUpload.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    profileImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
            
            // 编辑资料模态窗口
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const editProfileModal = document.getElementById('edit-profile-modal');
            const editProfileClose = document.getElementById('edit-profile-close');
            const editProfileForm = document.getElementById('edit-profile-form');
            
            editProfileBtn.addEventListener('click', function() {
                editProfileModal.style.display = 'flex';
            });
            
            editProfileClose.addEventListener('click', function() {
                editProfileModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === editProfileModal) {
                    editProfileModal.style.display = 'none';
                }
            });
            
            editProfileForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // 获取表单数据
                const name = document.getElementById('edit-name').value;
                const position = document.getElementById('edit-position').value;
                const phone = document.getElementById('edit-phone').value;
                const email = document.getElementById('edit-email').value;
                const department = document.getElementById('edit-department').value;
                
                // 更新个人资料显示
                document.getElementById('user-name').textContent = name;
                document.getElementById('user-position').textContent = `交通警卫处 · ${position}`;
                document.getElementById('user-phone').textContent = phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
                document.getElementById('user-email').textContent = email;
                document.getElementById('user-department').textContent = department;
                
                // 显示成功消息
                alert('个人资料已更新');
                
                // 关闭模态窗口
                editProfileModal.style.display = 'none';
            });
            
            // 报告问题模态窗口
            const reportIssueBtn = document.getElementById('report-issue-btn');
            const reportIssueModal = document.getElementById('report-issue-modal');
            const reportIssueClose = document.getElementById('report-issue-close');
            const reportIssueForm = document.getElementById('report-issue-form');
            
            reportIssueBtn.addEventListener('click', function() {
                reportIssueModal.style.display = 'flex';
            });
            
            reportIssueClose.addEventListener('click', function() {
                reportIssueModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === reportIssueModal) {
                    reportIssueModal.style.display = 'none';
                }
            });
            
            reportIssueForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // 获取表单数据
                const issueType = document.getElementById('issue-type').value;
                const issueTitle = document.getElementById('issue-title').value;
                const issueDescription = document.getElementById('issue-description').value;
                
                // 在实际应用中，这里应该将问题提交到服务器
                console.log('问题类型:', issueType);
                console.log('问题标题:', issueTitle);
                console.log('问题描述:', issueDescription);
                
                // 显示成功消息
                alert('问题报告已提交，感谢您的反馈！');
                
                // 重置表单
                reportIssueForm.reset();
                
                // 关闭模态窗口
                reportIssueModal.style.display = 'none';
            });
        }
        
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        menuToggle.addEventListener('click', () => sidebar.classList.toggle('active'));
        
        // 导航按钮点击事件
        document.getElementById('home-btn').addEventListener('click', () => {
            window.location.href = 'login.html';  // 跳转到test目录下的login.html
        });

        document.getElementById('dashboard-btn').addEventListener('click', () => {
            window.location.href = 'modified-code.html';  // 跳转到test目录下的modified-code.html
        });

        document.getElementById('details-btn').addEventListener('click', () => {
            window.location.href = 'details.html';  // 跳转到test目录下的details.html
        });

        document.getElementById('vlm-btn').addEventListener('click', () => {
            // 已经在智能交互页，不需要跳转
        });

        document.getElementById('review-btn').addEventListener('click', () => {
            createModal('<h3>系统通知</h3><p style="margin-top: 20px;">已通知相关技术人员</p>');
        });

        document.getElementById('contact-btn').addEventListener('click', () => {
            createModal('<h3>联系方式</h3><p style="margin-top: 20px; line-height: 1.6;">电话：400-123-4567<br>邮箱：support@ainonmotor.com<br>地址：科技园区88号人工智能大厦</p>');
        });
        
        // 初始化
        window.onload = function() {
            // 设置用户资料功能
            setupProfileFunctions();
            
            // 自动滚动到最新消息
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };
    </script>
</body>
</html>